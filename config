ngx_feature="ngx_small_light dependencies"
RHEL=$(rpm -E %{rhel})
if (( $RHEL > 7 )); then
  echo 'RHEL 8 and newer'
  ngx_feature_libs="-lMagickWand-6.Q16 -lMagickCore-6.Q16    -lMagickWand-6.Q16 -lMagickCore-6.Q16  "
  ngx_feature_inc_path="$ngx_feature_inc_path -I/usr/include/ImageMagick-6  -DMAGICKCORE_HDRI_ENABLE=0 -DMAGICKCORE_QUANTUM_DEPTH=16   "
else
  ngx_feature_libs="`pkg-config --libs-only-l MagickWand`"
  ngx_feature_inc_path="$ngx_feature_inc_path  `pkg-config ImageMagick --cflags-only-I`    "
fi
ngx_feature_name=
ngx_feature_run=no
ngx_feature_incs="#include <wand/MagickWand.h>
"
ngx_feature_path=
ngx_feature_test="MagickWandGenesis();
"

. auto/feature

if [ $ngx_found = no ]; then
    cat <<EOF
The compilation test below failed:

$ngx_feature_incs
$ngx_feature_test
EOF
    exit 1
fi

CORE_LIBS="$CORE_LIBS $ngx_feature_libs"

SMALL_LIGHT_SRCS="                                                    \
                $ngx_addon_dir/src/ngx_http_small_light_module.c      \
                $ngx_addon_dir/src/ngx_http_small_light_parser.c      \
                $ngx_addon_dir/src/ngx_http_small_light_param.c       \
                $ngx_addon_dir/src/ngx_http_small_light_size.c        \
                $ngx_addon_dir/src/ngx_http_small_light_type.c        \
                $ngx_addon_dir/src/ngx_http_small_light_imagemagick.c \
                "

SMALL_LIGHT_DEPS="                                                    \
                $ngx_addon_dir/src/ngx_http_small_light_module.h      \
                $ngx_addon_dir/src/ngx_http_small_light_parser.h      \
                $ngx_addon_dir/src/ngx_http_small_light_param.h       \
                $ngx_addon_dir/src/ngx_http_small_light_size.h        \
                $ngx_addon_dir/src/ngx_http_small_light_type.h        \
                $ngx_addon_dir/src/ngx_http_small_light_imagemagick.h \
                "

if (( $RHEL > 7 )); then
  echo 'RHEL 8 and newer'
  CFLAGS="${CFLAGS} -I/usr/include/ImageMagick-6 -fopenmp -DMAGICKCORE_HDRI_ENABLE=0 -DMAGICKCORE_QUANTUM_DEPTH=16      "
else
  CFLAGS="${CFLAGS} -fopenmp -I/usr/include/ImageMagick       "
fi

ngx_addon_name=ngx_http_small_light_module

if test -n "$ngx_module_link"; then
    ngx_module_type=HTTP_AUX_FILTER
    ngx_module_name=$ngx_addon_name
    ngx_module_deps="$SMALL_LIGHT_DEPS"
    ngx_module_srcs="$SMALL_LIGHT_SRCS"
    ngx_module_libs="$ngx_module_libs $ngx_feature_libs"

   . auto/module
else
    HTTP_AUX_FILTER_MODULES="$HTTP_AUX_FILTER_MODULES $ngx_addon_name"
    NGX_ADDON_SRCS="$NGX_ADDON_SRCS $SMALL_LIGHT_SRCS"
    NGX_ADDON_DEPS="$NGX_ADDON_DEPS $SMALL_LIGHT_DEPS"
fi
